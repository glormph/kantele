# Generated by Django 4.2.13 on 2024-12-06 14:13

from django.db import migrations, models



def split_mssamples_into_acquisition_and_sampleprep(a, s):
    SP = a.get_model('datasets', 'SelectParameter')
    SP.objects.exclude(title='Acquisition mode').update(category=2)
    DC = a.get_model('datasets', 'DatatypeComponent')
    DT = a.get_model('datasets', 'Datatype')
    # For all dt with comp=3 (acquisition), create a component=5 (sampleprep)
    DC.objects.bulk_create([DC(datatype=dt, component=5) for dt in 
        DT.objects.filter(datatypecomponent__component=3)])
    DCS = a.get_model('datasets', 'DatasetComponentState')
    for dtc in DC.objects.filter(component=5):
        # For each new sampleprep datatypecomponent, first get dtc for same datatype with acqu
        acq_dc = DC.objects.filter(datatype=dtc.datatype, component=3).get()
        # Then create new dcstate objects for all of those dcs that have acq component
        DCS.objects.bulk_create([DCS(dataset=dcs.dataset, dtcomp=dtc, state=dcs.state)
            for dcs in DCS.objects.filter(dtcomp=acq_dc)])


def fake(a, s):
    pass


class Migration(migrations.Migration):

    dependencies = [
        ('datasets', '0019_deletes'),
    ]

    operations = [
        migrations.AlterField(
            model_name='checkboxparameter',
            name='category',
            field=models.IntegerField(choices=[(1, 'MS Acquisition'), (2, 'MS Sample prep')]),
        ),
        migrations.AlterField(
            model_name='datatypecomponent',
            name='component',
            field=models.IntegerField(choices=[(1, 'Files'), (2, 'Samples'), (3, 'MS Acquisition'), (4, 'Definition'), (5, 'MS Sampleprep'), (6, 'LC samples'), (7, 'Pooled LC samples')]),
        ),
        migrations.AlterField(
            model_name='fieldparameter',
            name='category',
            field=models.IntegerField(choices=[(1, 'MS Acquisition'), (2, 'MS Sample prep')]),
        ),
        migrations.AlterField(
            model_name='selectparameter',
            name='category',
            field=models.IntegerField(choices=[(1, 'MS Acquisition'), (2, 'MS Sample prep')]),
        ),

        migrations.RunPython(split_mssamples_into_acquisition_and_sampleprep, fake),
    ]
