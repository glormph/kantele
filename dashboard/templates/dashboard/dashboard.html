{% extends "base.html" %}
{% block content %}
<link href="https://cdn.pydata.org/bokeh/release/bokeh-0.12.13.min.css" rel="stylesheet" type="text/css">
<script src="https://cdn.pydata.org/bokeh/release/bokeh-0.12.13.min.js"></script>
<section id="apps">
{% verbatim %}
<div class="tabs is-toggle is-centered is-small">
	<ul>
		<li v-for="(instr, instr_id) in instruments"> <a v-on:click="activateInstrTab(instr_id)">
			<span>{{ instr }}</span>
		</a></li>
		<li><a v-on:click="activateJobTab"><span>Jobs</span></a></li>
	</ul>
</div>
<div class="container">
<a class="button is-info is-small" v-on:click="reload">Refresh</a>
<hr>
	<section>
		<instrument-plot v-for="(instr, instr_id) in instruments" v-bind:key="instr_id" v-bind:instrument_id="instr_id" v-bind:active="instrTabOpenStatus[instr_id]" v-bind:loaded="qcdata[instr_id].loaded" v-bind:bokeh_code="qcdata[instr_id].bokeh_code"></instrument-plot>
		<job-box v-bind:jobdata="jobdata" v-bind:active="otherTabStatus.jobs" v-on:getjobs="getJobs"></job-box>
	</section>
</div>
</section>

<script>
	Vue.component('instrument-plot', {
		template: `
		<div class="bk-root" v-show="active" v-if="loaded" >
			<h5 class="title is-5"># Identifications</h5>
			<div class="bk-plotdiv" v-bind:id="bokeh_code.div.amount_peptides.elementid"></div>
			<hr>
                        <h5 class="title is-5"># PSMs</h5>
                        <div class="bk-plotdiv" v-bind:id="bokeh_code.div.amount_psms.elementid"></div>
                        <hr>
                        <h5 class="title is-5">Peptide precursor areas</h5>
                        <div class="bk-plotdiv" v-bind:id="bokeh_code.div.precursorarea.elementid"></div>
                        <hr>
                        <h5 class="title is-5">PSM MSGFScore</h5>
                        <div class="bk-plotdiv" v-bind:id="bokeh_code.div.msgfscore.elementid"></div>
                        <hr>
                        <h5 class="title is-5">Precursor error (ppm)</h5>
                        <div class="bk-plotdiv" v-bind:id="bokeh_code.div.prec_error.elementid"></div>
                        <hr>
                        <h5 class="title is-5">Retention time (min)</h5>
                        <div class="bk-plotdiv" v-bind:id="bokeh_code.div.rt.elementid"></div>
                        <hr>
		</div> `,
                props: ['instruments', 'instrument_id', 'active', 'loaded', 'bokeh_code'],
		data: function() {
			return {
			}
		},
	})
	Vue.component('job-box', {
		template: `
<table class="table" v-show="active">
	<thead>
		<tr>
			<th>Job</th>
			<th>User</th>
			<th>Date</th>
			<th>Tasks</th>
		</tr>
	</thead>
		<tr v-for="job in jobdata.error">
			<td>
				<a v-bind:title="job.alttexts.join(',')" v-if="job.retry" v-on:click="retryJob(job.id)" class="button is-outlined is-small is-danger">{{ job.name }}</a>
				<a v-bind:title="job.alttexts.join(',')" v-if="!job.retry" class="button is-small is-danger">{{ job.name }}</a>
			</td>
			<td>{{ job.user }}</td>
			<td>{{ job.date }}</td>
			<td>
				<a v-if="job.tasks.PENDING" class="button is-info">{{ job.tasks.PENDING }}</a>
				<a v-if="job.tasks.FAILURE" class="button is-danger">{{ job.tasks.FAILURE }}</a>
				<a v-if="job.tasks.SUCCESS" class="button is-success">{{ job.tasks.SUCCESS }}</a>
			</td>
		</tr>
		<tr v-for="job in jobdata.processing">
			<td><a v-bind:title="job.alttexts.join(',')" class="button is-small is-warning">{{ job.name }}</a></td>
			<td>{{ job.user }}</td>
			<td>{{ job.date }}</td>
			<td>
				<a v-if="job.tasks.PENDING" class="button is-info">{{ job.tasks.PENDING }}</a>
				<a v-if="job.tasks.FAILURE" class="button is-danger">{{ job.tasks.FAILURE }}</a>
				<a v-if="job.tasks.SUCCESS" class="button is-success">{{ job.tasks.SUCCESS }}</a>
			</td>
		</tr>
		<tr v-bind:title="job.alttexts.join(',')" v-for="job in jobdata.pending">
			<td><a class="button is-small is-info">{{ job.name }}</a></td>
			<td>{{ job.user }}</td>
			<td>{{ job.date }}</td>
			<td>
			</td>
		</tr>

</table>
		`,
		props: ['active', 'jobdata'],
		data: function() {
			return {
                        	processing: [],
                        	pending: [],
                        	error: [],
			}
		},
		methods: {
                        retryJob: function(job_id) {
				this.$http.post(`/jobs/retry/${job_id}`)
				.then(response => {
					return response
				}, response => {
					console.log(response);
					// error code
				}).then(result => {
					this.$emit('getjobs');
				})
                        },
		},
	})
	{% endverbatim %}

	var dashboard = new Vue({
	el: '#apps',
	data: function() {
		return { 
			instruments: { {% for inst, inst_id in instruments %} '{{ inst_id }}' : '{{ inst }}', {% endfor %} },
			instrTabOpenStatus: { {% for inst_id in instrument_ids %} '{{ inst_id }}': false, {% endfor %}},
			qcdata: { {% for inst_id in instrument_ids %} {{ inst_id}}: {'loaded': false, 'bokeh_code': {'div': {'amount_peptides': 1, 'amount_psms': 1, 'precursorarea': 1, 'prec_error': 1, 'msgfscore': 1, 'rt': 1 } }

 }, {% endfor %}
},
			otherTabStatus: {'jobs': false},
			activeTab: false,
			activeInstrument: false,
			jobdata: {'processing': [], 'error': [], 'pending': []},
		}
	},
	methods: {
		getInstrumentQC: function(instr_id) {
			this.$http.get('/dash/longqc/' + instr_id)
			.then(response => {
				return response.json()
			}, response => { console.log('error');
			}).then(result => {
				this.qcdata[instr_id] = {};
				for (key in result) {
					this.qcdata[instr_id][key] = result[key];
				}
				eval(this.qcdata[instr_id].bokeh_code.script);
				this.instrTabOpenStatus[instr_id] = true;
				this.qcdata[instr_id].loaded = true;
			})
		},
		getJobs: function() {
			this.$http.get('/dash/jobs/')
			.then(response => {
				return response.json()
			}, response => {
			}).then(result => {
				for (key in result) {
					this.jobdata[key] = result[key];
				}
			})
		},
		reload: function() {
			this.instrTabOpenStatus[this.activeInstrument] = false;
			if (this.activeTab === 'instrument') {
				this.qcdata[this.activeInstrument].loaded = false;
				this.getInstrumentQC(this.activeInstrument);
			} else if (this.activeTab === 'jobs') {
				this.getJobs();
			}
		},
		deactivateTabs: function() {
			for (instId in this.instrTabOpenStatus) {
				this.instrTabOpenStatus[instId] = false;
			}
			this.otherTabStatus.jobs = false;
		},
                activateInstrTab: function(instr_id) {
			this.deactivateTabs();
                        if (!this.qcdata[instr_id].loaded) {
				this.getInstrumentQC(instr_id);
 			} else {
				this.instrTabOpenStatus[instr_id] = true;
			}
			this.activeTab = 'instrument';
			this.activeInstrument = instr_id;
                },
		activateJobTab: function() {
			this.getJobs();
			this.deactivateTabs();
			this.otherTabStatus.jobs = true;
			this.activeTab = 'jobs';
		},
	},
})
</script>
{% endblock content %}
