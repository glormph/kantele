# -*- coding: utf-8 -*-
# Generated by Django 1.11.20 on 2019-09-11 12:41
from __future__ import unicode_literals

from django.db import migrations, models
import django.utils.timezone
from django.db.models import F, Min


def fetch_first_dset(apps, schema_editor):
    Project = apps.get_model('datasets', 'Project')
    pmap = {x['pk']: x['experiment__runname__dataset__date__min'] for x in Project.objects.all().annotate(Min('experiment__runname__dataset__date')).values('pk', 'experiment__runname__dataset__date__min')}
    for proj in Project.objects.all():
        if pmap[proj.id]:
            proj.registered = pmap[proj.id]
        else:
            proj.registered = django.utils.timezone.now()
        proj.save()
    

def set_to_now(apps, schema_editor):
    Project = apps.get_model('datasets', 'Project')
    Project.objects.all().update(registered=timezone.now())


class Migration(migrations.Migration):

    dependencies = [
        ('datasets', '0009_auto_20190426_0928'),
    ]

    operations = [
        migrations.AddField(
            model_name='project',
            name='registered',
            field=models.DateTimeField(auto_now_add=True, default=django.utils.timezone.now),
            preserve_default=False,
        ),
        migrations.RunPython(fetch_first_dset, set_to_now),
    ]
