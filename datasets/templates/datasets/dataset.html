{% extends "datasets/base.html" %}
{% block content %}
<section>
<div class="container" id="apps">

		<project-box></project-box>
		<!-- make a grid of files, sortable header buttons:
		# instrument, date, fn	
		And a filter field for removing scrap?
		Also, use this field to select files after the fact? 
		And for removing? Change list after save maybe is good.
		-->
</div>
</section>

<script>
	Vue.component('sampleprep-box', {
		props: ['dset_id', 'filenames'],
		template: `<div class="box" id="sampleprep" v-show="isOpen">
			<article class="message is-danger" v-if="errors.length > 0">
				<div class="message-body">
					<ul>
						{% verbatim %}
						<li v-for="error in errors">{{ error }}</li>
						{% endverbatim %}
					</ul>
				</div>
			</article>
			<!-- FIXME only show when MS data 
			organism, organ, enrichment, mod-enrichment, treatment, channel
			-->
			<div class="title is-5">MS Samples and preparation
				<a class="button is-danger is-small" v-on:click="save">Save</a>
			</div> 
			<div class="field">
				<label class="label">Enzymes</label>
				<input type="checkbox" v-model="no_enzyme">No enzyme
				{% verbatim %}
				<div class="control" v-for="enzyme in show_enzymes" v-show="!no_enzyme">
					<input v-bind:value="enzyme.id" v-model="enzymes" type="checkbox">{{ enzyme.name }}
				</div>
				{% endverbatim %}
			</div>
			<template v-for="param in params">
			<div class="field">
			{% verbatim %}
				<label class="label">{{ param.title }}</label>
				<div class="control">
					<template v-if="param.inputtype != 'select'">
					<input type="text" v-if="param.inputtype === 'text'" class="input" v-bind:placeholder="param.placeholder" v-model="param.model">
					<input type="number" v-if="param.inputtype === 'number'" class="input" v-bind:placeholder="param.placeholder" v-model="param.model">
					</template>

					<template v-if="param.inputtype === 'select'">
					<div class="select">
						<select v-model="param.model">
							<option disabled value="">Please select one</option>
							<template v-for="option in param.fields">
							<option v-bind:value="option.value">
							{{ option.text }}
							</option>
							</template>
						</select>
					</div>
					</template>
				</div>
			{% endverbatim %}
			</div>
			</template>
			<div class="field">
				<label class="label">Quant type</label>
				<div class="control">
					<div class="select">
						<select v-model="quanttype">
							<option disabled value="">Please select one</option>
							{% verbatim %}
							<option value="labelfree">Labelfree</option>
							<option v-for="quant in quants" v-bind:value="quant.id">{{ quant.name }}</option>
							{% endverbatim %}
						</select>
					</div>
				</div>
			</div>
			<div class="field" v-if="quanttype">
				<label class="label">Sample name(s)</label>
				<div class="control">
					<div id="labelfree_samples" v-if="quanttype === 'labelfree'">
						<input type="checkbox" v-model="labelfree_multisample" v-on:change="labelfree_check_samples">One sample per file?
					</div>
				</div>
				<table class="table">
					<thead>
						<tr>
							<th v-if="labelfree_multisample">Filename</th>
							<th v-if="quanttype != 'labelfree'">Channel</th>
							<th>Sample</th>
						</tr>
					</thead>
					{% verbatim %}
					<tbody>
						<!-- FIXME v-model etc for sample names and include the file ID! -->
						<tr v-for="channel in quants[quanttype].chans" v-if="quanttype != 'labelfree'">
							<td>{{ channel.name }}</td>
							<td><input class="text"></td>
						</tr>
						<tr v-if="labelfree_multisample && filenames.length" v-for="file in filenames">
							<td>{{ file.name }}</td>
							<td><input class="text"></td>
						</tr>
						<tr v-if="labelfree_multisample && !filenames.length">
							<td><div class="notification is-danger">CLAIM FILES FIRST</div></td>
						</tr>
					</tbody>
					{% endverbatim %}
				</table>
			</div>
		</div>`,

		data: function() {
		return { 
			errors: [],
			no_enzyme: false,
			isOpen: true,
			labelfree_multisample: false,
			show_enzymes: [],
			quants: [],
			params: [],
			// models
			enzymes: [],
			quanttype: '',
			}
		},
		mounted: function() {
			this.fetchData()
		},

		methods: {
			labelfree_check_samples: function() {
				return true
			},
			fetchData: function() {
			       	this.$http.get('/datasets/show/sampleprep/' + this.dset_id)
				.then(response => {
					return response.json()
					}, response => {
				       	console.log(response)
					}).then(result => {
					for (key in result) {
						this[key] = result[key];
					}
			       	})
	       		},
			validate: function() {
				this.errors = [];
				if (!this.operator_id) {
					this.errors.push('Operator is required');
				}
				for (var i = 0; i < this.params.length; i++) {
					if (this.params[i].model === "") {
						this.errors.push(this.params[i].title + ' is required');
					}
				}
				console.log(this.errors);
				return this.errors.length ? false : true

			},
			save: function() {
				if (!this.validate()) {
					return false
				}
				data = {
					dataset_id: this.dset_id,
					enzyme_id: this.enzyme_id,
					params: this.params,
				};
				this.$http.post('/datasets/save/sampleprep/', data
					).then(response => {
						console.log(response);
					}, response => {
						console.log(response);
				});
			},
		},
	})

	Vue.component('files-box', {
		template: `
	<div class="column">
		<div class="box" v-show="isOpen">
			<div class="title is-5">Files
			       	<a class="button is-danger is-small" v-on:click="save">Save</a>

			</div>
			<a class="button is-danger is-outlined is-small" v-show="showDatasetFiles" v-on:click="toggleFileView">Show available files</a>
			<a class="button is-danger is-outlined is-small" v-show="!showDatasetFiles" v-on:click="toggleFileView">
				{% verbatim %}
				Show {{ datasetAssociatedFiles.length }} dataset files
				{% endverbatim %}
			</a>
			<input class="input"  v-model="filefilterString" type="text" placeholder="Filter files" v-show="!showDatasetFiles">
			<table class="table">
				<thead>
					<tr>
						<th>
					<div class="control">
						<input type="checkbox" v-show="!showDatasetFiles">
					</div>
			</th>
						<th>Filename</th>
						<th>Instrument</th>
						<th>Production date</th>
					</tr>
				</thead>
				<tbody>
					<tr v-for="file in datasetAssociatedFiles" v-if="showDatasetFiles">
						<td>
							<div class="control">
								<a class="icon">
									<i class="fa fa-home"></i>
								</a>
							</div>
						</td>
						{% verbatim %}
						<td>{{ file.name }}</td>
						<td>{{ file.instrument }}</td>
						<td>{{ file.date }}</td>
						{% endverbatim %}
					</tr>
					<tr v-for="file in newFiles" v-if="!showDatasetFiles" v-show="filtered_files(file)">
						<td>
							<div class="control">
								<input type="checkbox">
							</div>
						</td>
						{% verbatim %}
						<td>{{ file.name }}</td>
						<td>{{ file.instrument }}</td>
						<td>{{ file.date }}</td>
						{% endverbatim %}
					</tr>
				</tbody>
			</table>
		</div>
		<sampleprep-box v-bind:dset_id="dset_id" v-bind:filenames="datasetAssociatedFiles"></sampleprep-box>
	</div>
		`,
		data: function() {return {
			isSaved: false,
			isOpen: true,
			showDatasetFiles: {% if newdataset %}false{% else %}true{% endif %},
			filefilterString: '',
			newFiles: [],
			datasetAssociatedFiles: [
			{% for file in dataset_files %}
			{
				id: '{{ file.id }}',
				name: '{{ file.name }}',
				instrument: '{{ file.instrument }}',
				date: '{{ file.date }}',
			},
			{% endfor %}
			],
		}
		},
		props: ['dset_id'],
		mounted: function() {
			this.fetchData()
		},
		methods: {
			toggleFileView: function() {
				this.showDatasetFiles = this.showDatasetFiles === false;
			},
			fetchData: function() {
			       	this.$http.get('/datasets/show/files/' + this.dset_id)
				.then(response => {
					return response.json()
					}, response => {
				       	console.log(response)
					}).then(result => {
					for (key in result) {
						this[key] = result[key];
					}
			       	})

			},
			save: function() {
				console.log('implement save');
				// POST list:[file ids] and dataset ID of course

				// call save URL with vue-resource, 
				// include values of project.
				// Parse response ok or not.
				// Show error or green and rollup.
			},
			filtered_files: function(file) {
				return file.name.indexOf(this.filefilterString) > -1
			},
		}
	})

	Vue.component('acquisition-box', {
		template: `
		<div class="box" v-show="isOpen">
			<article class="message is-danger" v-if="errors.length > 0">
				<div class="message-body">
					<ul>
						{% verbatim %}
						<li v-for="error in errors">{{ error }}</li>
						{% endverbatim %}
					</ul>
				</div>
			</article>
			<div class="title is-5">Acquisition
				<a class="button is-danger is-small" v-on:click="save">Save</a>
		</div> 
		<div class="field">
			<label class="label">Operator</label>
			<div class="control">
				<div class="select">
					<select v-model="operator_id">
						<option disabled value="">Please select one</option>
						{% verbatim %}
						<option v-for="operator in operators" v-bind:value="operator.id">{{ operator.name }}</option>
					        {% endverbatim %}
					</select>
				</div>
			</div>
		</div>
		<template v-for="param in params">
		<div class="field">
		{% verbatim %}
			<label class="label">{{ param.title }}</label>
			<div class="control">
				<template v-if="param.inputtype != 'select'">
				<input type="text" v-if="param.inputtype === 'text'" class="input" v-bind:placeholder="param.placeholder" v-model="param.model">
				<input type="number" v-if="param.inputtype === 'number'" class="input" v-bind:placeholder="param.placeholder" v-model="param.model">
				</template>

				<template v-if="param.inputtype === 'select'">
				<div class="select">
					<select v-model="param.model">
						<option disabled value="">Please select one</option>
						<template v-for="option in param.fields">
						<option v-bind:value="option.value">
						{{ option.text }}
						</option>
						</template>
					</select>
				</div>
				</template>
			</div>
		{% endverbatim %}
		</div>
		</template>
	</div>
`,
	data: function() {
		return {
			errors: [],
			params: [],
		 	operators: [],
			operator_id: '',
			isSaved: false,
			isOpen: true,
			}
		},
	mounted: function() {
		this.fetchData()
		},
	props: ['dset_id'],
	methods: {
		fetchData: function() {
			this.$http.get('/datasets/show/acquisition/' + this.dset_id)
			.then(response => {
				return response.json()
				}, response => {
				console.log(response)
				}).then(result => {
				for (key in result) {
					this[key] = result[key];
				}
			})
	       	},
		validate: function() {
			this.errors = [];
			if (!this.operator_id) {
				this.errors.push('Operator is required');
			}
			for (var i = 0; i < this.params.length; i++) {
				if (this.params[i].model === "") {
					this.errors.push(this.params[i].title + ' is required');
				}
			}
			console.log(this.errors);
			return this.errors.length ? false : true

		},
		save: function() {
			if (!this.validate()) {
				return false
			}
			data = {
				dataset_id: this.dset_id,
				operator_id: this.operator_id,
				params: this.params,
			};
			this.$http.post('/datasets/save/acquisition/', data
				).then(response => {
					console.log(response);
				}, response => {
				console.log(response);
			});
			},
		
		},
	})
	
	Vue.component('project-box', {
		template: `
	<div class="columns">
		<div class="column">
		<div class="box" id="project" v-if="isOpen">
			<article class="message is-danger" v-if="errors.length > 0">
				<div class="message-body">
					<ul>
						{% verbatim %}
						<li v-for="error in errors">{{ error }}</li>
						{% endverbatim %}
					</ul>
				</div>
			</article>
			<div class="title is-5">Project
				<a class="button is-danger is-small" v-on:click="save">Save</a>
			</div>
		<div class="field">
			<label class="label">Name
			<a class="button is-danger is-outlined is-small" v-show="isNewProject" v-on:click="toggle_project">Use existing project</a>
			<a class="button is-danger is-outlined is-small" v-show="!isNewProject" v-on:click="toggle_project">Create new project</a>
	</label>
			<div class="control" v-if="!isNewProject">
				<div class="select">
					<select v-model="project_id" v-on:change="project_selected">
						<option disabled value="">Please select one</option>
					        {% verbatim %}
						<option v-for="project in projects" v-bind:value="project.id">{{ project.name }}</option>
					        {% endverbatim %}
					</select>
				</div>
			</div>
			<template v-if="isNewProject">
			<div class="control">
				<input class="input" v-model="newprojectname" type="text" placeholder="Project name">
			</div>
		        <div class="field">
		        	<div class="control">
		        	<label class="checkbox">
					<input type="checkbox" v-model="newproject_iscf">
		        		Core facility project
		        	</label>
		        	</div>
		        </div>
			</template>
		</div>
		
		<div class="field" v-if="is_corefac">
			<label class="label">contact(s)
				<template v-if="isNewProject">
					<a class="button is-danger is-outlined is-small" v-show="isNewPI" v-on:click="new_pi">Use existing PI</a>
					<a class="button is-danger is-outlined is-small" v-show="!isNewPI" v-on:click="new_pi">Create new PI</a>
				</template>
				<span class="tag is-success is-medium">Core facility project</span>
	 	      	</label>
			<template v-if="isNewProject">
			<div class="control" v-if="!isNewPI">
				<div class="select">
					<select v-model="externpi">
						<option disabled value="">Please select one</option>
						{% verbatim %}
						<option v-for="externpi in external_pis" v-bind:value="externpi.id">{{ externpi.name }}</option>
						{% endverbatim %}
					</select>
				</div>
			</div>
			<div class="control" v-if="isNewPI">
				<input class="input" v-model="newpiname" type="text" placeholder="PI name">
			</div>
			</template>
			<div class="control">
				<input class="input" type="text" v-model="externalcontactmail" placeholder="operational contact email (e.g. postdoc)">
			</div>
		</div>
		
		<div class="field">
			<label class="label">Experiment name
				<a class="button is-danger is-outlined is-small" v-show="isNewExperiment" v-on:click="toggle_experiment">Existing experiment</a>
				<a class="button is-danger is-outlined is-small" v-show="!isNewExperiment" v-on:click="toggle_experiment">Create new experiment</a>
	       		</label>
			<div class="control" v-if="!isNewExperiment">
				<div class="select">
					<select v-model="experiment_id">
						<option disabled value="">Please select one</option>
						{% verbatim %}
						<option v-for="exp in proj_experiments" v-bind:value="exp.id">{{ exp.name }}</option>
						{% endverbatim %}
					</select>
				</div>
			</div>
			<div class="control" v-if="isNewExperiment">
				<input class="input" v-model="newexperimentname" type="text" placeholder="Experiment name">
			</div>
		</div>
		
		<div class="field">
			<label class="label">Dataset type</label>
			<div class="control">
				<div class="select">
					<select v-model="datatype_id">
						<option disabled value="">Please select one</option>
						{% verbatim %}
						<option v-for="dset_type in datasettypes" v-bind:value="dset_type.id">{{ dset_type.name }}</option>
						{% endverbatim %}
					</select>
				</div>
			</div>
		</div>
		<div class="field" v-show="datatype_id === 1">
			<label class="label">HiRIEF range</label>
			<div class="control">
				<div class="select">
					<select v-model="hiriefrange">
						<option disabled value="">Please select one</option>
					        {% verbatim %}
						<option v-for="range in hirief_ranges" v-bind:value="range.id">{{ range.name }}</option>
					        {% endverbatim %}
					</select>
				</div>
			</div>
		</div>
	</div>
	<acquisition-box v-bind:dset_id="dataset_id"></acquisition-box>
	</div>
	<files-box v-bind:dset_id="dataset_id"></files-box>
</div>
`,
		data: function() {
		return {
			errors: [],
			isOpen: true,
		       	isNewProject: false,
		       	isNewExperiment: false,
			isNewPI: false,
			dataset_id: '{{ dataset_id }}',
			newprojectname: '',
			newexperimentname: '',
			projects: [],
			external_pis: [],
			datasettypes: [],
			internal_pi_id: '',
			hirief_ranges: [],
			project_id: '',
			experiment_id: '',
			datatype_id: '',
			hiriefrange: '',
			experiment_id: '',
			experiments: {},
			newproject_iscf: false,
			existingproject_iscf: false,
			externpi: '',
			newpiname: '',
			externalcontactmail: '',
			}
		},
		mounted: function() {
			this.fetchData()
		},
		computed: {
		is_corefac: function() {
			if (this.isNewProject) {return this.newproject_iscf}
			else {return this.existingproject_iscf}
			},
		proj_experiments: function() {
			return !this.project_id ? [] : this.experiments[this.project_id]
			},
		project_lookup: function() {
			project_lookup = {};
			for (var i = 0; i < this.projects.length; i++) {
	       			project_lookup[this.projects[i].id] = {'corefac': this.projects[i].corefac, 'pi_id': this.projects[i].pi_id};
				}
			return project_lookup
			},
		},

		methods: {
			fetchData: function() {
			       	this.$http.get('/datasets/show/project/' + this.dataset_id)
				.then(response => {
					return response.json()
					}, response => {
				       	console.log(response)
					}).then(result => {
					for (key in result) {
						this[key] = result[key];
					}
			       	})
	       		},
			checkOpen: function() {
				this.isOpen = this.loaded;
			},
			project_selected: function() {
				if (this.project_id) {
					this.existingproject_iscf = this.project_lookup[this.project_id].corefac;
					this.pi_id = this.project_lookup[this.project_id].pi_id;
				}
			},
		       	toggle_project: function() {
				this.isNewProject = this.isNewProject === false;
		       	},
			toggle_experiment: function() {
				this.isNewExperiment = this.isNewExperiment === false;
			},
		       	new_pi: function() {
				this.isNewPI = this.isNewPI === false;
			},
			validate: function() {
				this.errors = [];
				if (!this.newprojectname && !this.project_id) {
					this.errors.push('Project needs to be selected or created');
				}
				if (!this.newexperimentname && !this.experiment_id) {
					this.errors.push('Experiment is required');
				}
				if (!this.datatype_id) {
					this.errors.push('Datatype is required');
				}
				if (this.datatype_id === '1' && !this.hiriefrange) {
					this.errors.push('HiRIEF range is required');
				}
				if (this.is_corefac) {
					if (!this.newpiname && !this.pi_id) {
						this.errors.push('Need to select or create a PI');
					}
					if (!this.externalcontactmail) {
						this.errors.push('External contact is required');
					}
				}
				console.log(this.errors);
				return this.errors.length ? false : true
			},

			save: function() {
				if (!this.validate()) {
					return false
				}
				data = {
					dataset_id: this.dataset_id,
					is_corefac: this.is_corefac,
					datatype_id: this.datatype_id,
					hiriefrange: this.hiriefrange,
				};
				if (this.isNewProject) {
					data.newprojectname = this.newprojectname;
					} else {
					data.project_id = this.project_id;
					}
				if (this.isNewExperiment) {
				data.newexperimentname = this.newexperimentname;
				} else {
			       	data.experiment_id = this.experiment_id;
				}
				if (this.isNewPI) {
				data.newpiname = this.newpiname;
				} else {
				data.pi_id = this.is_corefac ? this.externpi: this.internalpi;
				}
				if (this.is_corefac) {
				data.corefaccontact = this.externalcontactmail;
				}
				this.$http.post('/datasets/save/project/', data
					).then(response => {
						for (var key in response.body) {
							console.log(key);
							this[key] = response.body[key];
						}
					       	this.isNewProject = false;
					       	this.isNewExperiment = false;
						this.isNewPI = false;
					}, response => {
					console.log(response);
				});
			}
				},
				})
		
	var motherapp = new Vue({
	el: '#apps',
	})
</script>
{% endblock content %}
