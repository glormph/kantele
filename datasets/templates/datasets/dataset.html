{% extends "base.html" %}
{% block content %}
<section id="apps">
<div class="tabs is-toggle is-centered is-small">
	<ul>
		<li v-bind:class="tabclassDef"><a v-on:click="showDef">
				<span v-show="definition_state === 'ok'" class="icon is-small">
					<i  class="fa fa-check"></i>
				</span>
				<span v-show="definition_state === 'new'" class="icon is-small">
					<i  class="fa fa-pencil"></i>
				</span>
				<span v-show="dataset_id === ''" class="icon is-small">
					<i class="fa fa-times"></i>
				</span>
				<span>Definition</span>
		</a></li>
		<li v-bind:class="tabclassFiles">
			<a v-on:click="showFiles">
				<span v-show="files_state === 'ok'" class="icon is-small">
					<i  class="fa fa-check"></i>
				</span>
				<span v-show="files_state === 'new'" class="icon is-small">
					<i  class="fa fa-pencil"></i>
				</span>
				<span v-show="dataset_id === ''" class="icon is-small">
					<i class="fa fa-times"></i>
				</span>
				<span>Files</span>
			</a>
		</li>
		<li v-if="componentEnabled('acquisition')" v-bind:class="tabclassAcq"><a v-on:click="showAcquisition">
				<span v-show="acquisition_state === 'ok'" class="icon is-small">
					<i  class="fa fa-check"></i>
				</span>
				<span v-show="acquisition_state === 'new'" class="icon is-small">
					<i  class="fa fa-pencil"></i>
				</span>
				<span v-show="dataset_id === ''" class="icon is-small">
					<i class="fa fa-times"></i>
				</span>
				<span>Acquisition</span>
		</a></li>
		<li v-if="componentEnabled('sampleprep')" v-bind:class="tabclassSP"><a v-on:click="showSP">
				<span v-show="sampleprep_state === 'ok'" class="icon is-small">
					<i  class="fa fa-check"></i>
				</span>
				<span v-show="sampleprep_state === 'new'" class="icon is-small">
					<i  class="fa fa-pencil"></i>
				</span>
				<span v-show="dataset_id === '' || sampleprep_state === 'incomplete'" class="icon is-small">
					<i class="fa fa-times"></i>
				</span>
				<span>Sample prep</span></a></li>
	</ul>
</div>
<div class="container">
		<project-box v-on:save="save_definition" v-on:revert="fetchProject" v-show="viewtab === 'definition'" v-bind:is_owner="is_owner" v-bind:local_ptype_id="local_ptype_id" v-bind:saveerrors="projerrors" v-bind:dset_id="dataset_id" v-bind:projsaved="projsaved" v-bind:pdata="projdata"></project-box>
		<acquisition-box v-on:save="save_acquisition" v-on:revert="fetchAcquisition" v-if="componentEnabled('acquisition')" v-show="viewtab === 'acquisition'" v-bind:acqsaved="acqsaved" v-bind:is_owner="is_owner" v-bind:dset_id="dataset_id" v-bind:acqdata="acqdata"></acquisition-box>
		<files-box v-on:save="save_files" v-on:revert="fetchFiles" v-show="viewtab === 'files'" v-bind:is_owner="is_owner" v-bind:dset_id="dataset_id" v-bind:fnsaved="fnsaved" v-bind:fndata="filesdata"></files-box>
		<sampleprep-box v-on:save="save_sampleprep" v-on:revert="fetchSampleprep" v-if="componentEnabled('sampleprep')" v-show="viewtab === 'sampleprep'" v-bind:spsaved="spsaved" v-bind:is_owner="is_owner" v-bind:dset_id="dataset_id" v-bind:assoc_filenames="filesdata.datasetAssociatedFiles" v-bind:spdata="sampledata"></sampleprep-box>
</div>
</section>

<script>
	Vue.component('sampleprep-box', {
		template: `
	<div class="columns">
			<div class="column" />
			<div class="column is-two-thirds">
			<div class="box" v-if="!isOpen">
				<div class="title is-5">MS Samples and preparation</div>
				<article class="message is-danger"> 
				<div class="message-body">Save definition first</div></article>
			</div>
		        <div class="box" id="sampleprep" v-if="isOpen">
			<article class="message is-danger" v-if="errors.length > 0">
				<div class="message-body">
					<ul>
						{% verbatim %}
						<li v-for="error in errors">{{ error }}</li>
						{% endverbatim %}
					</ul>
				</div>
			</article>
			<div class="title is-5">MS Samples and preparation
				<a v-if="is_owner" v-show="showsave" class="button is-danger is-small" v-on:click="save">Save</a>
				<a v-if="is_owner" v-show="!showsave" class="button is-danger is-small" disabled>Save</a>
				<a v-if="is_owner" v-show="showrevert" class="button is-info is-small" v-on:click="revert">Revert</a>
				<a v-if="is_owner" v-show="!showrevert" class="button is-info is-small" disabled>Revert</a>
			</div> 
			<div class="field">
				<label class="label">Enzymes</label>
				<input type="checkbox" v-on:change="editing=true" v-model="spdata.no_enzyme">No enzyme
				{% verbatim %}
				<div class="control" v-for="enzyme in spdata.show_enzymes" v-show="!spdata.no_enzyme">
					<input v-on:change="editing=true" v-bind:value="enzyme.id" v-model="spdata.enzymes" type="checkbox">{{ enzyme.name }}
				</div>
				{% endverbatim %}
			</div>
			<template v-for="param in spdata.params">
			<div class="field">
			{% verbatim %}
				<label class="label">{{ param.title }}</label>
				<div class="control">
					<template v-if="param.inputtype === 'text'|| param.inputtype === 'number'">
					<input type="text" v-on:input="editing=true" v-if="param.inputtype === 'text'" class="input" v-bind:placeholder="param.placeholder" v-model="param.model">
					<input type="number" v-on:input="editing=true" v-if="param.inputtype === 'number'" class="input" v-bind:placeholder="param.placeholder" v-model="param.model">
					</template>

					<template v-if="param.inputtype === 'select'">
					<div class="select" >
						<select v-on:change="editing=true" v-model="param.model">
							<option disabled value="">Please select one</option>
							<template v-for="option in param.fields">
							<option v-bind:value="option.value">
							{{ option.text }}
							</option>
							</template>
						</select>
					</div>
					</template>
					<template v-if="param.inputtype === 'checkbox'">
				<div class="control" v-for="option in param.fields">
					<input v-on:change="editing=true" v-bind:value="option.value" v-model="param.model" type="checkbox">{{ option.text }}
					</div>
					</template>
				</div>
			{% endverbatim %}
			</div>
			</template>
			<div class="field">
				<label class="label">Quant type</label>
				<div class="control">
					<div class="select">
						<select v-on:change="editing=true" v-model="spdata.quanttype">
							<option disabled value="">Please select one</option>
							{% verbatim %}
							<option v-for="quant in spdata.quants" v-bind:value="quant.id">{{ quant.name }}</option>
							{% endverbatim %}
						</select>
					</div>
				</div>
			</div>
			<div class="field" v-if="spdata.quanttype">
				<label class="label">Samples</label>
				<textarea class="textarea" v-model="trysamplenames" placeholder="Try this: paste your sample names here (one line per sample, tab separated sample/file or channel)"></textarea>
				<a class="button is-primary" v-on:click="parseSampleNames">Parse sample names</a>
				<div class="control">
					<div id="labelfree_samples" v-if="spdata.quanttype === labelfree_quant_id">
						<input type="checkbox" v-model="spdata.labelfree_multisample">One sample per file?
					</div>
				</div>
				<table class="table is-fullwidth" >
					<thead>
						<tr>
							<th v-if="spdata.quanttype === labelfree_quant_id && spdata.labelfree_multisample">Filename</th>
							<th v-if="spdata.quanttype != labelfree_quant_id">Channel</th>
							<th>Sample name</th>
						</tr>
					</thead>
					{% verbatim %}
					<tbody>
						<tr v-for="channel in spdata.quants[spdata.quanttype].chans" v-if="spdata.quanttype != labelfree_quant_id">
							<td>{{ channel.name }}</td>
							<td><input v-model="channel.model" class="input is-normal"></td>
						</tr>
						<template v-if="spdata.quanttype === labelfree_quant_id">
						<tr v-if="!filenames.length">
							<td><div class="notification is-danger">CLAIM FILES FIRST</div></td>
						</tr>
						<tr v-show="spdata.labelfree_multisample && filenames.length && parsedsamples" v-for="file in filenames">
							<td>{{ file.name }}</td>
							<td><input v-model="spdata.samples[file.associd]" class="input is-normal"></td>
						</tr>
						<tr v-show="!spdata.labelfree_multisample && filenames.length && spdata.quanttype === labelfree_quant_id">
							<td><input v-model="spdata.quants[spdata.quanttype].model" class="input is-normal"></td>
						</tr>
						</template>
					</tbody>
					{% endverbatim %}
				</table>
			</div>
	</div>
</div>
			<div class="column" />
			</div>
`,

		props: ['dset_id', 'is_owner', 'spdata', 'assoc_filenames', 'spsaved'],
		data: function() {
		return { 
			editing: false,
			errors: [],
                        trysamplenames: '',
			parsedsamples: true,
			}
		},
		mounted: function() {
			this.wait_noedit();
		},
		computed: {
			showsave: function() {
				if (!this.spsaved || this.editing) {
					return true
				} else {
					return false
				}
			},
			showrevert: function() {
				if (this.showsave ) {
					return true
				} else {
					return false
				}
			},
			isOpen: function() {
				return this.dset_id !== '';
				},
			filenames: function() {
				fns = [];
				for (key in this.assoc_filenames) {
					fns.push(this.assoc_filenames[key]);
					}
				this.spdata.filenames = fns;
				return fns
			},
			labelfree_quant_id: function() {
				for (qid in this.spdata.quants) {
					if (this.spdata.quants[qid].name === 'labelfree') {
						return this.spdata.quants[qid].id
						}
					}
				},
			},
		
		methods: {
			wait_noedit: async function() {
				// VERY DIRTY TRICK
			// WAIT SO THE DATA IS LOADED WITH AN ASYNC FETCH OVER URL (triggering v-on:change in fields, leading to editing is set to true)
			// THE SET THE EDITING BACK TO FALSE
				await this.sleep(1000);
				this.editing = false;
			},
			sleep: function(ms) {
				return new Promise(resolve => setTimeout(resolve, ms));
			},
			parseSampleNames: function() {
				this.parsedsamples = false;
				fnmap = {};
				if (this.labelfree_quant_id === this.spdata.quanttype) {
					for (fn of this.filenames) {
						fnmap[fn.name] = fn;
					}
				} else {
					for (ch of this.spdata.quants[this.spdata.quanttype].chans) {
						fnmap[ch.name] = ch;
					}
				}
				for (line of this.trysamplenames.trim().split('\n')) {
 					line = line.trim().split('\t');
					if (this.labelfree_quant_id === this.spdata.quanttype) {
						if (line[0] in fnmap) {
							this.spdata.samples[fnmap[line[0]].associd] = line[1];
						} else if (line[1] in fnmap) {
							this.spdata.samples[fnmap[line[1]].associd] = line[0];
						}
					} else {
						if (line[0] in fnmap) {
							fnmap[line[0]].model = line[1];
						} else if (line[1] in fnmap) {
							fnmap[line[1]].model = line[0];
						}
					}
				}
				this.editing = true;
				this.parsedsamples = true;
			},
			validate: function() {
				this.errors = [];
				if (!this.spdata.no_enzyme && !this.spdata.enzymes.length) {
					this.errors.push('Enzyme selection is required');
				}
				if (!this.spdata.quanttype) {
					this.errors.push('Quant type selection is required');
				}
				if (this.labelfree_quant_id === this.spdata.quanttype) {
					this.spdata.labelfree = true;
					if (this.spdata.labelfree_multisample) {
						for (fn of this.filenames) {
							if (!this.spdata.samples[fn.associd]) {
								this.errors.push('Labelfree multi-sample requires sample name for each file');
								break;
							}
								
					 	}	
					}
					else if (!this.spdata.quants[this.spdata.quanttype].model) {
						this.errors.push('Labelfree requires sample name');
						}
				} else {
					this.spdata.labelfree = false;
					for (ch of this.spdata.quants[this.spdata.quanttype].chans) {
						if (ch.model === '') { 
							this.errors.push('Sample name for each channel is required');
							break;
						}
					}
				}
				for (key in this.spdata.params) {
					if (this.spdata.params[key].model === "") {
						this.errors.push(this.spdata.params[key].title + ' is required');
					}
				}
				console.log(this.errors);
				return this.errors.length ? false : true

			},
			revert: function() {
				this.$emit('revert');
				this.wait_noedit();
			},
			save: function() {
				if (!this.validate()) {
					return false
				}
				this.editing = false;
				this.$emit('save');
			},
		},
	})

	Vue.component('files-box', {
		template: `
			<div class="columns">
			<div class="column" />
			<div class="column is-two-thirds">
		<div class="box" v-show="!isOpen">
			<div class="title is-5">Files</div>
			<article class="message is-danger"> 
			<div class="message-body">Save definition first</div></article>
		</div>
		<div class="box" v-show="isOpen">
			<div class="title is-5">Files
				<a v-if="is_owner" v-show="showsave" class="button is-danger is-small" v-on:click="save">Save</a>
				<a v-if="is_owner" v-show="!showsave" class="button is-danger is-small" disabled>Save</a>
				<a v-if="is_owner" v-show="showrevert" class="button is-info is-small" v-on:click="revert">Revert</a>
				<a v-if="is_owner" v-show="!showrevert" class="button is-info is-small" disabled>Revert</a>

			</div>
			<div v-show="showDatasetFiles">
				{% verbatim %}
				<a class="button is-danger is-outlined is-small" v-on:click="toggleFileView">Show available files</a>
				<a class="button is-primary is-outlined is-small" v-on:click="removeFiles">Remove {{ countSelectedAssocFiles }} selected files</a>
				<input class="input"  v-model="filefilterAssocString" type="text" placeholder="Filter files">
				<div class="content is-small">{{ Object.keys(showingAssociatedFiles).length }} dataset files</div>
			</div>
			
			<div v-show="!showDatasetFiles">
				<a class="button is-danger is-outlined is-small" v-on:click="toggleFileView">
				Show {{ Object.keys(showingAssociatedFiles).length }} dataset files
				</a>
				<a class="button is-primary is-outlined is-small" v-on:click="addFiles">Add {{ countSelectedFiles }} selected files</a>
				<input class="input"  v-model="filefilterString" type="text" placeholder="Filter files">
				<div class="content is-small">{{ Object.keys(showingNewFiles).length }} available files</div>
				{% endverbatim %}
			</div>
			<table class="table">
				<thead>
					<tr>
						<th>
							<div class="control">
								<input type="checkbox" v-show="showDatasetFiles" v-on:click="selectAllAssoc">
								<input type="checkbox" v-show="!showDatasetFiles" v-on:click="selectAll">
							</div>
				       		</th>
						<th v-show="showDatasetFiles"></th>
						<th v-show="!showDatasetFiles">
							<a class="button is-info is-outlined" v-on:click="toggleFileSort">Filename</a>
						</th>
						<th v-show="showDatasetFiles">Filename</th>
						<th v-show="!showDatasetFiles">
							<div class="control">
								<div class="select">
									<select v-model="instrumentSort">
										<option disabled value="">Instrument</option>
										<option v-bind:value="''">All</option>
										{% verbatim %}
										<option v-for="inst in fndata.instruments" v-bind:value="inst">{{ inst }}</option>
										{% endverbatim %}
									</select>
								</div>
							</div>
						</th>
						<th v-show="showDatasetFiles">Instrument</th>
						<th v-show="!showDatasetFiles">
							<div class="control">
								<div class="select">
									<select v-model="timeSort">
										<option disabled value="">Production date</option>
										<option value="604800000">Last week</option>
										<option value="2629800000">Last month</option>
										<option value="15778800000">Last half year</option>
										<option value="31557600000">Last year</option>
										<option value="">All</option>
									</select>
								</div>
							</div>
						</th>
						<th v-show="showDatasetFiles">Production date</th>
						<th>Size</th>
					</tr>
				</thead>
				<tbody>
					<tr v-for="file in showingAssociatedFiles" v-if="showDatasetFiles" v-show="filtered_assoc_files(file)">
						<td>
							<div class="control">
								<input v-model="file.checked" type="checkbox">
							</div>
						</td>
						<td>
							<div class="control">
								<a class="has-text-danger icon" v-on:click="removeFile(file)">
									<i class="fa fa-times"></i>
								</a>
							</div>
						</td>
						{% verbatim %}
						<td>{{ file.name }}</td>
						<td>{{ file.instrument }}</td>
						<td>{{ isoTime(file.date) }}</td>
						<td>{{ file.size }} MB</td>
						{% endverbatim %}
					</tr>
					<tr v-for="file in showingNewFiles" v-if="!showDatasetFiles" v-show="filtered_files(file)">
						<td>
							<div class="control">
								<input v-model="file.checked" type="checkbox">
							</div>
						</td>
						{% verbatim %}
						<td>{{ file.name }}</td>
						<td>{{ file.instrument }}</td>
						<td>{{ isoTime(file.date) }}</td>
						<td>{{ file.size }} MB</td>
						{% endverbatim %}
					</tr>
				</tbody>
			</table>
		</div> 
	</div> 
			<div class="column" />
			</div>
		`,
		props: ['dset_id', 'is_owner', 'fndata', 'fnsaved'],
		data: function() {return {
			showDatasetFiles: {% if newdataset %}false{% else %}true{% endif %},
			filefilterString: '',
			filefilterAssocString: '',
			sort_order: 1,
			instrumentSort: '',
			timeSort: '2629800000',
			allSelector: false,
			allAssocSelector: false,
			editing: false,
		}
		},
		computed: {
			showsave: function() {
				if (!this.fnsaved || this.editing) {
					return true
				} else {
					return false
				}
			},
			showrevert: function() {
				if (this.showsave ) {
					return true
				} else {
					return false
				}
			},
			isOpen: function() {
				return this.dset_id !== '';
			},
			countSelectedAssocFiles: function() {
				count = 0;
				for (key in this.showingAssociatedFiles) {
					if (this.showingAssociatedFiles[key].checked) {
						count += 1;
					}
				}
				return count
			},
			countSelectedFiles: function() {
				count = 0;
				for (key in this.showingNewFiles) {
					if (this.showingNewFiles[key].checked) {
						count += 1;
					}
				}
				return count
			},
			showingNewFiles: function() {
				sort_order = this.sort_order;
				var val = Object.assign({}, this.fndata.newFiles, this.fndata.removedFiles)
				for (key in this.fndata.addedFiles) {
					delete val[key];
				}
				return val
// SORTING DOES WORK BUT DISABLES PROPER FILE ADD AND REMOVE
//				files = [];
//				for (key in val) {
//					files.push(val[key]);
//				}
//				return files.sort(function(a, b) {
//				if (a.name > b.name) {
//					return sort_order;
//					} else if (a.name < b.name) {
//					return -sort_order;
//					} else {
//					return 0;
//					}})
			},
			showingAssociatedFiles: function() {
				var val = Object.assign({}, this.fndata.datasetAssociatedFiles, this.fndata.addedFiles)
				for (key in this.fndata.removedFiles) {
					delete val[key];
					}
				return val
			},
		},
		methods: {
			wait_noedit: async function() {
				// VERY DIRTY TRICK
				// WAIT SO THE DATA IS LOADED WITH AN ASYNC FETCH OVER URL (triggering v-on:change in fields, leading to editing is set to true)
				// THE SET THE EDITING BACK TO FALSE
				await this.sleep(1000);
				this.editing = false;
			},
			sleep: function(ms) {
				return new Promise(resolve => setTimeout(resolve, ms));
			},
			revert: function() {
				this.$emit('revert');
				this.wait_noedit();
			},
			isoTime: function(timestamp) {
				x = new Date(timestamp);
				return x.toISOString();
			},
			toggleFileSort: function() {
				this.sort_order = -this.sort_order;
			}, 
			toggleFileView: function() {
				this.showDatasetFiles = this.showDatasetFiles === false;
			},
			selectAllAssoc: function() {
				this.allAssocSelector = this.allAssocSelector === false;
				for (key in this.showingAssociatedFiles) {
					file = this.showingAssociatedFiles[key];
					if (this.filtered_assoc_files(file) && this.allAssocSelector) {
						file.checked = true;
						} else {
						file.checked = false;
						}
				}
			},
			selectAll: function() {
				this.allSelector = this.allSelector === false;
				for (key in this.showingNewFiles) {
					file = this.showingNewFiles[key];
					if (this.filtered_files(file) && this.allSelector) {
						file.checked = true;
						} else {
						file.checked = false;
						}
				}
			},
			addFiles: function() {
				shownew = this.showingNewFiles;
				add_from_remove = []
				for (key in shownew) {
					if (shownew[key].checked) {
						shownew[key].checked = false;
						if (key in this.fndata.removedFiles) {
							add_from_remove.push(key);
							} else {
							this.$set(this.fndata.addedFiles, key, shownew[key])
							}
					}
				}	
				rmf = Object.assign({}, this.fndata.removedFiles);
				for (i=0; i<add_from_remove.length; i++) {
					delete rmf[key];
				}
				this.fndata.removedFiles = rmf;
				this.editing = true;
			},
			removeFiles: function() {
				tmpdsfiles = Object.assign({}, this.fndata.datasetAssociatedFiles, this.fndata.addedFiles)
				for (key in tmpdsfiles) {
					file = tmpdsfiles[key];
					if (file.checked) {
						this.removeFile(file);
					}
				}
			},
			removeFile: function(file) {
				file_id = 'id_' + file.id
				if (file_id in this.fndata.addedFiles) {
					addf = Object.assign({}, this.fndata.addedFiles)
					delete addf[file_id];
					this.fndata.addedFiles = addf;
				} else {
					this.$set(this.fndata.removedFiles, file_id, file);
					}
				file.checked = false;
				this.editing = true;
			},
			save: function() {
				this.editing = false;
				this.$emit('save');
			},
			filtered_assoc_files: function(file) {
				return file.name.indexOf(this.filefilterAssocString) > -1
			},
			filtered_files: function(file) {
				if (this.instrumentSort !== '' && file.instrument !== this.instrumentSort) {
					return false	
					}
				var timestamp = new Date();
				if (this.timeSort !== '' && file.date < timestamp.valueOf() - this.timeSort){
					return false	
					}
				return file.name.indexOf(this.filefilterString) > -1
			},
		}
	})

	Vue.component('acquisition-box', {
		template: `
			<div class="columns">
			<div class="column" />
			<div class="column is-two-thirds">
			<div class="box" v-show="!isOpen">
				<div class="title is-5">Acquisition</div>
				<article class="message is-danger"> 
				<div class="message-body">Save definition first</div></article>
			</div>
		<div class="box" v-show="isOpen">
			<article class="message is-danger" v-if="errors.length > 0">
				<div class="message-body">
					<ul>
						{% verbatim %}
						<li v-for="error in errors">{{ error }}</li>
						{% endverbatim %}
					</ul>
				</div>
			</article>
			<div class="title is-5">Acquisition
				<a v-if="is_owner" v-show="showsave" class="button is-danger is-small" v-on:click="save">Save</a>
				<a v-if="is_owner" v-show="!showsave" class="button is-danger is-small" disabled>Save</a>
				<a v-if="is_owner" v-show="showrevert" class="button is-info is-small" v-on:click="revert">Revert</a>
				<a v-if="is_owner" v-show="!showrevert" class="button is-info is-small" disabled>Revert</a>
		</div> 
		<div class="field">
			<label class="label">Operator</label>
			<div class="control">
				<div class="select">
					<select v-model="acqdata.operator_id" v-on:change="editing=true">
						<option disabled value="">Please select one</option>
						{% verbatim %}
						<option v-for="operator in acqdata.operators" v-bind:value="operator.id">{{ operator.name }}</option>
					        {% endverbatim %}
					</select>
				</div>
			</div>
		</div>
		<div class="field">
			<label class="label">Reverse phase length</label>
			<div class="control">
				<input type="checkbox" v-on:change="editing=true" v-model="acqdata.dynamic_rp">Dynamic
				<input type="number" v-on:input="editing=true" class="input" placeholder="in minutes" v-model="acqdata.rp_length" v-show="!acqdata.dynamic_rp">
			</div>
		</div>
		<template v-for="param in acqdata.params">
		<div class="field">
		{% verbatim %}
			<label class="label">{{ param.title }}</label>
			<div class="control">
				<template v-if="param.inputtype != 'select'">
				<input type="text" v-on:input="editing=true" v-if="param.inputtype === 'text'" class="input" v-bind:placeholder="param.placeholder" v-model="param.model">
				<input type="number" v-on:input="editing=true" v-if="param.inputtype === 'number'" class="input" v-bind:placeholder="param.placeholder" v-model="param.model">
				</template>

				<template v-if="param.inputtype === 'select'">
				<div class="select">
					<select v-model="param.model" v-on:change="editing=true">
						<option disabled value="">Please select one</option>
						<template v-for="option in param.fields">
						<option v-bind:value="option.value">
						{{ option.text }}
						</option>
						</template>
					</select>
				</div>
				</template>
			</div>
		{% endverbatim %}
		</div>
		</template>
</div></div>
			<div class="column" />
			</div>
`,
	data: function() {
		return {
			errors: [],
			editing: false,
			}
		},
	props: ['dset_id', 'is_owner', 'acqdata', 'acqsaved'],
	computed: {
		showsave: function() {
			if (!this.acqsaved || this.editing) {
				return true
			} else {
				return false
			}
		},
		showrevert: function() {
			if (this.showsave ) {
				return true
			} else {
				return false
			}
		},
		isOpen: function() {
			return this.dset_id !== '';
		},
	},
	mounted: function() {
		this.wait_noedit();
		},
	methods: {
		wait_noedit: async function() {
			// VERY DIRTY TRICK
			// WAIT SO THE DATA IS LOADED WITH AN ASYNC FETCH OVER URL (triggering v-on:change in fields, leading to editing is set to true)
			// THE SET THE EDITING BACK TO FALSE
			await this.sleep(1000);
			this.editing = false;
		},
		sleep: function(ms) {
			return new Promise(resolve => setTimeout(resolve, ms));
		},
		revert: function() {
			console.log('reverting');
			this.$emit('revert');
			this.wait_noedit();
		},
		validate: function() {
			this.errors = [];
			if (!this.acqdata.operator_id) {
				this.errors.push('Operator is required');
			}
			if (!this.acqdata.dynamic_rp && !this.acqdata.rp_length) {
				this.errors.push('Reverse phase is required');
			}
			for (key in this.acqdata.params) {
				if (this.acqdata.params[key].model === "") {
					this.errors.push(this.acqdata.params[key].title + ' is required');
				}
			}
			console.log(this.errors);
			return this.errors.length ? false : true

		},
		save: function() {
			if (!this.validate()) {
				return false
			}
			this.editing = false;
			this.$emit('save');
			},
		
		},
	})
	
	Vue.component('project-box', {
		props: ['dset_id', 'local_ptype_id', 'is_owner', 'pdata', 'projsaved', 'saveerrors'],
		template: `
	<div class="columns">
		<div class="column"/>
		<div class="column is-two-thirds">
		<div class="box" id="project" v-if="isOpen">
			<article class="message is-danger" v-if="errors.length > 0">
				<div class="message-body">
					<ul>
						{% verbatim %}
						<li v-for="error in saveerrors">{{ error }}</li>
						<li v-for="error in errors">{{ error }}</li>
						{% endverbatim %}
					</ul>
				</div>
			</article>
			<div class="title is-5">Dataset definition
				<a v-if="is_owner" v-show="showsave" class="button is-danger is-small" v-on:click="save">Save</a>
				<a v-if="is_owner" v-show="!showsave" class="button is-danger is-small" disabled>Save</a>
				<a v-if="is_owner" v-show="showrevert" class="button is-info is-small" v-on:click="revert">Revert</a>
				<a v-if="is_owner" v-show="!showrevert" class="button is-info is-small" disabled>Revert</a>
			</div>
		<div class="field">
			<label class="label">Project
			<a class="button is-danger is-outlined is-small" v-show="isNewProject" v-on:click="toggle_project">Use existing project</a>
			<a class="button is-danger is-outlined is-small" v-show="!isNewProject" v-on:click="toggle_project">Create new project</a>
	</label>
			<div class="control" v-if="!isNewProject">
				<div class="select">
					<select v-model="pdata.project_id" v-on:change="project_selected">
						<option disabled value="">Please select one</option>
					        {% verbatim %}
						<option v-for="project in pdata.projects" v-bind:value="project.id">{{ project.name }}</option>
					        {% endverbatim %}
					</select>
				</div>
			</div>
			<template v-if="isNewProject">
			<div class="control">
				<input class="input" v-on:input="editing=true" v-model="pdata.newprojectname" type="text" placeholder="Project name">
			</div>
		        <div class="field">
		        	<div class="control">
				<label class="label">Project type</label>
				<div class="select">
					<select v-model="pdata.ptype_id" v-on:change="editing=true">
						<option disabled value="">Please select one</option>
					        {% verbatim %}
						<option v-for="ptype in pdata.ptypes" v-bind:value="ptype.id">{{ ptype.name }}</option>
					        {% endverbatim %}
					</select>
				</div>
		        	</div>
		        </div>
			</template>
		</div>
		
		<div class="field" v-if="is_external">
			<label class="label">contact(s)
				<template v-if="isNewProject">
					<a class="button is-danger is-outlined is-small" v-show="isNewPI" v-on:click="new_pi">Use existing PI</a>
					<a class="button is-danger is-outlined is-small" v-show="!isNewPI" v-on:click="new_pi">Create new PI</a>
				</template>
				<span class="tag is-success is-medium">External project</span>
	 	      	</label>
			<template v-if="isNewProject">
			<div class="control" v-if="!isNewPI">
				<div class="select">
					<select v-on:change="editing=true" v-model="pdata.externpi">
						<option disabled value="">Please select one</option>
						{% verbatim %}
						<option v-for="expi in pdata.external_pis" v-bind:value="expi.id">{{ expi.name }}</option>
						{% endverbatim %}
					</select>
				</div>
			</div>
			<div class="control" v-if="isNewPI">
				<input class="input" v-on:input="editing=true" v-model="pdata.newpiname" type="text" placeholder="PI name">
			</div>
			</template>
			<div class="control">
				<input class="input" type="text" v-on:change="editing=true" v-model="pdata.externalcontactmail" placeholder="operational contact email (e.g. postdoc)">
			</div>
		</div>
		
		<div class="field">
			<label class="label">Experiment name
				<a class="button is-danger is-outlined is-small" v-show="isNewExperiment" v-on:click="toggle_experiment">Existing experiment</a>
				<a class="button is-danger is-outlined is-small" v-show="!isNewExperiment" v-on:click="toggle_experiment">Create new experiment</a>
	       		</label>
			<div class="control" v-if="!isNewExperiment">
				<div class="select">
					<select v-on:change="editing=true" v-model="pdata.experiment_id">
						<option disabled value="">Please select one</option>
						{% verbatim %}
						<option v-for="exp in proj_experiments" v-bind:value="exp.id">{{ exp.name }}</option>
						{% endverbatim %}
					</select>
				</div>
			</div>
			<div class="control" v-if="isNewExperiment">
				<input class="input" v-on:input="editing=true" v-model="pdata.newexperimentname" type="text" placeholder="Experiment name">
			</div>
		</div>
		<div class="field">
			<label class="label">Run name</label>
			<div class="control">
				<input class="input" v-on:input="editing=true" v-model="pdata.runname" type="text" placeholder="E.g set1, run1, etc">
			</div>
		</div>
		<div class="field">
			<label class="label">Prefractionation</label>
			<div class="control">
				<div class="select">
					<select v-model="pdata.prefrac_id" v-on:change="editing=true">
						<option value="">None</option>
						{% verbatim %}
						<option v-for="prefrac in pdata.prefracs" v-bind:value="prefrac.id">{{ prefrac.name }}</option>
					        {% endverbatim %}
					</select>
				</div>
			</div>
		</div>
		<div class="field" v-show="hiriefselected">
			<label class="label">HiRIEF range</label>
			<div class="control">
				<div class="select">
					<select v-on:change="editing=true" v-model="pdata.hiriefrange">
						<option disabled value="">Please select one</option>
					        {% verbatim %}
						<option v-for="range in pdata.hirief_ranges" v-bind:value="range.id">{{ range.name }}</option>
					        {% endverbatim %}
					</select>
				</div>
			</div>
		</div>
		<div class="field" v-show="pdata.prefrac_id && !hiriefselected">
			<label class="label">Prefractionation length</label>
			<div class="control">
				<input type="number" v-on:input="editing=true" class="input" placeholder="in minutes" v-model="pdata.prefrac_length">
			</div>
		</div>
		<div class="field" v-show="pdata.prefrac_id">
			<label class="label">Fraction amount</label>
			<div class="control">
				<input type="number" v-on:input="editing=true" class="input" placeholder="How many fractions of prefractionation" v-model="pdata.prefrac_amount">
			</div>
		</div>

		<div class="field">
			<label class="label">Organisms</label>
			<input type="checkbox" v-model="mostusedorganisms">Pick from most used
			<div class="tags">
				{% verbatim %}
				<span class="tag is-medium is-info" v-for="org in pdata.organism_ids">
					{{ org.name }}, {{ org.linnean }}
					<button class="delete is-small" v-on:click="removeOrganism(org.id)"></button>
				</span>
				{% endverbatim %}
			</div>
			<div class="control">
				<input class="input" v-model="organismfilter" type="text" placeholder="Filter organisms">
			</div>
			<div class="dropdown is-active" v-show="organismfilter">
				<div class="dropdown-menu" id="dropdown-menu" role="menu">
					<div class="dropdown-content">
					        {% verbatim %}
						<a v-on:click="addOrganism(org)" class="dropdown-item" v-for="org in filteredorganisms">{{ org.name }}, {{ org.linnean }}</a>
					        {% endverbatim %}
					</div>
				</div>
			</div>
		</div>
		
		<div class="field">
			<label class="label">Dataset type</label>
			<div class="control">
				<div class="select">
					<select v-on:change="editing=true" v-model="pdata.datatype_id">
						<option disabled value="">Please select one</option>
						{% verbatim %}
						<option v-for="dset_type in pdata.datasettypes" v-bind:value="dset_type.id">{{ dset_type.name }}</option>
						{% endverbatim %}
					</select>
				</div>
			</div>
		</div>
		<article class="message is-info"> 
		<div class="message-header">Storage location</div>
		{% verbatim %}
		<div class="message-body">{{ pdata.storage_location }}</div>
		{% endverbatim %}
		</article>
	</div>
	</div>
		<div class="column"/>
</div>
`,
		data: function() {
		return {
			errors: [],
			isOpen: true,
			isNewProject: false,
			isNewExperiment: false,
			isNewPI: false,
			organismfilter: '',
			mostusedorganisms: true,
			editing: false,
			}
		},
		computed: {
		showsave: function() {
			if (!this.projsaved || this.editing) {
				return true
			} else {
				return false
			}
		},
		showrevert: function() {
			if (this.showsave) {
				return true
			} else {
				return false
			}
		},
		is_external: function() {
			if (this.isNewProject) {
				this.pdata.is_external= this.pdata.ptype_id !== this.local_ptype_id;
				return this.pdata.is_external}
			else {
				this.pdata.is_external = this.pdata.existingproject_is_external;
				return this.pdata.existingproject_is_external}
			
			},
		filteredorganisms: function() {
			filteredorgs = [];
			if (this.mostusedorganisms) {
				for (org of this.pdata.mostused_organisms) {
					checkorg = org.linnean.concat(org.name).toLowerCase();
					if (checkorg.indexOf(this.organismfilter.toLowerCase()) > -1) {
						filteredorgs.push(org);
					}
				}
			} else {
				for (org of this.pdata.organisms) {
					checkorg = org.linnean.concat(org.name).toLowerCase();
					if (checkorg.indexOf(this.organismfilter.toLowerCase()) > -1) {
						filteredorgs.push(org);
					}
				}
			}
			return filteredorgs
		},
		proj_experiments: function() {
			return !this.pdata.project_id ? [] : this.pdata.experiments[this.pdata.project_id]
			},
		hiriefselected: function() {
			for (pf of this.pdata.prefracs) {
				if (this.pdata.prefrac_id === pf.id && pf.name.toLowerCase().indexOf('hirief') > -1) {
					return true
				}
			}
			return false;
		},
		},
		methods: {
			wait_noedit: async function() {
				// VERY DIRTY TRICK
				// WAIT SO THE DATA IS LOADED WITH AN ASYNC FETCH OVER URL (triggering v-on:change in fields, leading to editing is set to true)
				// THE SET THE EDITING BACK TO FALSE
				await this.sleep(1000);
				this.editing = false;
			},
			sleep: function(ms) {
				return new Promise(resolve => setTimeout(resolve, ms));
			},
			revert: function() {
				console.log('reverting');
				this.$emit('revert');
				this.wait_noedit();
			},
			project_selected: function() {
				this.editing = true;
				if (this.pdata.project_id) {
					this.pdata.existingproject_is_external = this.pdata.project_lookup[this.pdata.project_id].ptype_id !== this.local_ptype_id;
					this.pdata.pi_id = this.pdata.project_lookup[this.pdata.project_id].pi_id;
					this.pdata.ptype_id = this.pdata.project_lookup[this.pdata.project_id].ptype_id;
				}
			},
		       	toggle_project: function() {
				this.isNewProject = this.isNewProject === false;
				this.pdata.isNewProject = this.isNewProject;
		       	},
			toggle_experiment: function() {
				this.isNewExperiment = this.isNewExperiment === false;
				this.pdata.isNewExperiment = this.isNewExperiment;
			},
		       	new_pi: function() {
				this.isNewPI = this.isNewPI === false;
				this.pdata.isNewPI = this.isNewPI;
			},
			removeOrganism: function(orgid) {
				this.editing = true;
				delete this.pdata.organism_ids[orgid];
			},
			addOrganism: function(org) {
				this.editing = true;
				this.organismfilter = '';
				this.pdata.organism_ids[org.id] = org;
			},
			validate: function() {
				this.errors = [];
				re = RegExp('^[a-z0-9-_]+$', 'i');
				if (!this.pdata.newprojectname && !this.pdata.project_id) {
					this.errors.push('Project needs to be selected or created');
				}
				else if (this.pdata.newprojectname && !re.test(this.pdata.newprojectname)) {
					this.errors.push('Project name may only contain a-z 0-9 - _');
				}
				if (!this.pdata.newexperimentname && !this.pdata.experiment_id) {
					this.errors.push('Experiment is required');
				}
				else if (this.pdata.newexperimentname && !re.test(this.pdata.newexperimentname)) {
					this.errors.push('Experiment name may only contain a-z 0-9 - _');
				}
				if (!this.pdata.runname) {
					this.errors.push('Run name is required');
				}
				if (this.hiriefselected && !this.pdata.hiriefrange) {
					this.errors.push('HiRIEF range is required');
				}
				else if (!this.hiriefselected && this.pdata.prefrac_id && !this.pdata.prefrac_length) {
					this.errors.push('Prefractionation length is required');
				}
				if (this.pdata.prefrac_id && !this.pdata.prefrac_amount) {
					this.errors.push('Prefractionation fraction amount is required');
				}
				if (Object.keys(this.pdata.organism_ids).length === 0) {
					this.errors.push('Organism(s) is/are required');
				}
				else if (!re.test(this.pdata.runname)) {
					this.errors.push('Run name may only contain a-z 0-9 - _');
				}
				if (!this.pdata.datatype_id) {
					this.errors.push('Datatype is required');
				}
				if (this.is_external) {
					if (!this.pdata.newpiname && !this.pdata.pi_id) {
						this.errors.push('Need to select or create a PI');
					}
					if (!this.pdata.externalcontactmail) {
						this.errors.push('External contact is required');
					}
				}
				console.log(this.errors);
				return this.errors.length ? false : true
			},

			save: function() {
				if (!this.validate()) {
					return false
				}
				this.editing = false;
				this.$emit('save');
			},
				},
				})
		
	var datasetapp = new Vue({
	el: '#apps',
	data: function() {
		return {
			dtypecomponents: [],
			tabclassDef: 'is-active',
			tabclassFiles: '',
			tabclassAcq: '',
			tabclassSP: '',
			viewtab: 'definition',
			definition_state: '',
			acquisition_state: '',
			sampleprep_state: '',
			files_state: '',
                        projerrors: [],
			projdata: {
				projects: [],
				external_pis: [],
				datasettypes: [],
				internal_pi_id: '',
				pi_id: '',
				project_id: '',
			        ptype_id: {{ local_ptype_id }},
				datatype_id: '',
				experiment_id: '',
				experiments: {},
				existingproject_is_external: false,
				externpi: '',
				externalcontactmail: '',
				runname: '',
				prefracs: [],
				prefrac_id: '',
				prefrac_amount: '',
				prefrac_length: '',
				hirief_ranges: [],
				hiriefrange: '',
				organism_ids: {},
				storage_location: '',
				isNewProject: false,
				isNewExperiment: false,
				isNewPI: false,
				newprojectname: '',
				newexperimentname: '',
				newpiname: '',
				},
			acqdata: {
				params: {},
				operators: [],
				operator_id: '',
				dynamic_rp: false,
				rp_length: '',
				},
			filesdata: {
				newFiles: [],
				datasetAssociatedFiles: [],
				addedFiles: {},
				removedFiles: {},
				},
			sampledata: {
				no_enzyme: false,
				labelfree_multisample: false,
				show_enzymes: [],
				quants: {},
				params: {},
				enzymes: [],
				quanttype: '',
				samples: {},
				},
			spsaved: true,
			projsaved: true,
			fnsaved: true,
			acqsaved: true,
			dataset_id: '{{ dataset_id }}',
			is_owner: {{ is_owner }},
			local_ptype_id: {{ local_ptype_id }},
		}
	},
	mounted: function() {
		this.fetchProject();
		this.fetchFiles();
		this.fetchSampleprep();
		this.fetchAcquisition();
		this.fetchStates();
	},
	methods: {
		componentEnabled: function(compname) {
			return this.dtypecomponents.indexOf(compname) > -1
		},
		showDef: function() {
			this.viewtab = 'definition';
			this.activateTabClass('tabclassDef');
		},
		showFiles: function() {
			this.viewtab = 'files';
			this.activateTabClass('tabclassFiles');
		},
		showAcquisition: function() {
			this.viewtab = 'acquisition';
			this.activateTabClass('tabclassAcq');
		},
		showSP: function() {
			this.viewtab = 'sampleprep';
			this.activateTabClass('tabclassSP');
		},
		activateTabClass: function(tabname) {
			tabs = ['tabclassDef', 'tabclassSP', 'tabclassAcq', 'tabclassFiles'];
			for (offtab of tabs) {
				this[offtab] = '';
				}
			this[tabname] = 'is-active';
		},
		fetchData: function(url) {
			return this.$http.get(url)
			},
		fetchProject: function() {
			this.fetchData('/datasets/show/project/' + this.dataset_id)
				.then(response => {
					return response.json()
					}, response => {
					console.log(response)
					}).then(result => {
					for (key in result) {
						this.projdata[key] = result[key];
					}
				this.projdata.project_lookup = {};
				for (var i = 0; i < result.projects.length; i++) {
					this.projdata.project_lookup[result.projects[i].id] = {'ptype_id': result.projects[i].ptype_id, 'pi_id': result.projects[i].pi_id, 'name': result.projects[i].name};
					}
				this.dtypecomponents = this.projdata.components;
				})
			},

		fetchFiles: function() {
			this.fetchGeneral('files', this.filesdata);
			this.filesdata.addedFiles = {};
			this.filesdata.removedFiles = {};
		},
		fetchSampleprep: function() {
			this.fetchGeneral('sampleprep', this.sampledata);
		},
		fetchAcquisition: function() {
			this.fetchGeneral('acquisition',  this.acqdata);
		},
		fetchStates: function() {
			this.fetchGeneral('components', this);
		},
		fetchGeneral: function(category, store) {
			url = '/datasets/show/' + category + '/' + this.dataset_id;
			this.fetchData(url)
				.then(response => {
					return response.json()
					}, response => {
					console.log(response)
					}).then(result => {
					for (key in result) {
						if (key !== '') {
							store[key] = result[key];
						}
					}
				})
			},
		save_definition: function() {
			data = {
				dataset_id: this.dataset_id,
				ptype_id: this.projdata.ptype_id,
				datatype_id: this.projdata.datatype_id,
				organism_ids: this.projdata.organism_ids,
				runname: this.projdata.runname,
				prefrac_id: this.projdata.prefrac_id,
				prefrac_length: this.projdata.prefrac_length,
				prefrac_amount: this.projdata.prefrac_amount,
				hiriefrange: this.projdata.hiriefrange,
			};
			if (this.projdata.isNewProject) {
				data.newprojectname = this.projdata.newprojectname;
				} else {
				data.project_id = this.projdata.project_id;
				}
			if (this.projdata.isNewExperiment) {
			data.newexperimentname = this.projdata.newexperimentname;
			} else {
			data.experiment_id = this.projdata.experiment_id;
			}
			if (this.projdata.isNewPI) {
			data.newpiname = this.projdata.newpiname;
			} else {
			data.pi_id = this.projdata.is_external ? this.projdata.externpi : this.projdata.internal_pi_id;
			}
			if (this.projdata.ptype_id !== this.local_ptype_id) {
			data.externalcontact = this.projdata.externalcontactmail;
			}
			this.$http.post('/datasets/save/project/', data
				).then(response => {
					this.projdata.isNewProject = false;
					this.projdata.isNewExperiment = false;
					this.projdata.isNewPI = false;
					return response.json()
				}, response => {
				console.log(response);
				}).then(result => {
                                        if (result.error) {
                                            this.projerrors.push(result.error);
                                        } else {
                                            this.projerrors = [];
					    this.dataset_id = result.dataset_id;
					    this.fetchProject();
					    this.fetchStates();
                                        }
			})
		},
		save_files: function() {
			data = {
				'dataset_id': this.dataset_id,
				'added_files': this.filesdata.addedFiles,
				'removed_files': this.filesdata.removedFiles,
				}
			this.$http.post('/datasets/save/files/', data
				).then(response => {
					this.fetchFiles();
					this.fetchStates();
				}, response => {
				console.log(response);
				})
		},
		save_acquisition: function() {
			data = {
				dataset_id: this.dataset_id,
				operator_id: this.acqdata.operator_id,
				params: this.acqdata.params,
				rp_length: this.acqdata.dynamic_rp ? '' : this.acqdata.rp_length,
			};
			this.$http.post('/datasets/save/acquisition/', data
				).then(response => {
					console.log(response);
					this.fetchAcquisition();
					this.fetchStates();
				}, response => {
				console.log(response);
			});
		},
		save_sampleprep: function() {
				data = {
					dataset_id: this.dataset_id,
					enzymes: this.sampledata.no_enzyme ? [] : this.sampledata.enzymes,
					params: this.sampledata.params,
					quanttype: this.sampledata.quanttype,
					labelfree: this.sampledata.labelfree,
				};
				if (!data.labelfree) {
					data.samples = this.sampledata.quants[this.sampledata.quanttype].chans;
				} else if (this.sampledata.labelfree_multisample) {
					data.multisample = true;
					data.filenames = this.sampledata.filenames;
					data.samples = this.sampledata.samples;
				} else {
					data.multisample = false;
					data.filenames = this.sampledata.filenames;
					data.sample = this.sampledata.quants[this.sampledata.quanttype].model;
				}
				this.$http.post('/datasets/save/sampleprep/', data
					).then(response => {
						console.log(response);
						this.fetchSampleprep();
						this.fetchStates();
					}, response => {
		                		this.spsaved = false;
						console.log(response);
				});
		},
	},
	})
</script>
{% endblock content %}
